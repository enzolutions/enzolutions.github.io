<!DOCTYPE HTML>
<!--[if lt IE 7]><html class="no-js lt-ie9 lt-ie8 lt-ie7" lang="en"> <![endif]-->
<!--[if (IE 7)&!(IEMobile)]><html class="no-js lt-ie9 lt-ie8" lang="en"><![endif]-->
<!--[if (IE 8)&!(IEMobile)]><html class="no-js lt-ie9" lang="en"><![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en"><!--<![endif]-->
  <head>
    <title>How to add customs fields to SOLR index using Entity API &amp; Search API</title>
<meta http-equiv="content-type" content="text/html; charset=utf-8" />
<meta name="generator" content="Spress" />
<meta name="description" content="Enzo's blog" />
<meta name="keywords" content="" />


<!-- Twitter Cards -->
<meta name="twitter:title" content="Welcome to [enzo]lutions">
<meta name="twitter:description" content="{ page.description | default(site.description) }}">
<meta name="twitter:site" content="@enzolutions">
<meta name="twitter:creator" content="@">

<meta name="twitter:card" content="summary_large_image">
<meta name="twitter:image" content="http://enzolutions.com/">

<!-- Open Graph -->
<meta property="og:locale" content="en_US">
<meta property="og:type" content="article">
<meta property="og:title" content="Welcome to [enzo]lutions">
<meta property="og:description" content="Enzo's blog">
<meta property="og:url" content="http://enzolutions.com">
<meta property="og:site_name" content="Welcome to [enzo]lutions">

<link rel="canonical" href="http://enzolutions.com">
<link href="http://enzolutions.com/rss.xml" type="application/atom+xml" rel="alternate" title="Welcome to [enzo]lutions">
<link rel="author" href="enzolutions">

<!-- http://t.co/dKP3o1e -->
<meta name="HandheldFriendly" content="True">
<meta name="MobileOptimized" content="320">
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<!-- For all browsers -->
<link rel="stylesheet" href="http://enzolutions.com/assets/css/main.css">

<meta http-equiv="cleartype" content="on">

<!-- HTML5 Shiv and Media Query Support -->
<!--[if lt IE 9]>
  <script src="http://enzolutions.com/assets/js/vendor/html5shiv.min.js"></script>
  <script src="http://enzolutions.com/assets/js/vendor/respond.min.js"></script>
<![endif]-->

<!-- Modernizr -->
<script src="http://enzolutions.com/assets/js/vendor/modernizr-2.7.1.custom.min.js"></script>

<link href='//fonts.googleapis.com/css?family=PT+Sans+Narrow:400,700%7CPT+Serif:400,700,400italic' rel='stylesheet' type='text/css'>

<!-- Icons -->
<!-- 16x16 -->
<link rel="shortcut icon" href="http://enzolutions.com/favicon.ico">
<!-- 32x32 -->
<link rel="shortcut icon" href="http://enzolutions.com/favicon.png">
<!-- 57x57 (precomposed) for iPhone 3GS, pre-2011 iPod Touch and older Android devices -->
<link rel="apple-touch-icon-precomposed" href="http://enzolutions.com/assets/images/apple-touch-icon-precomposed.png">
<!-- 72x72 (precomposed) for 1st generation iPad, iPad 2 and iPad mini -->
<link rel="apple-touch-icon-precomposed" sizes="72x72" href="http://enzolutions.com/assets/images/apple-touch-icon-72x72-precomposed.png">
<!-- 114x114 (precomposed) for iPhone 4, 4S, 5 and post-2011 iPod Touch -->
<link rel="apple-touch-icon-precomposed" sizes="114x114" href="http://enzolutions.com/assets/images/apple-touch-icon-114x114-precomposed.png">
<!-- 144x144 (precomposed) for iPad 3rd and 4th generation -->
<link rel="apple-touch-icon-precomposed" sizes="144x144" href="http://enzolutions.com/assets/images/apple-touch-icon-144x144-precomposed.png">

<link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/highlight.js/8.4/styles/default.min.css">
<link rel="stylesheet" href="http://enzolutions.com/assets/css/highlight-theme.css">
  </head>

  <body class="home">
    <!--[if lt IE 9]><div class="browser-upgrade alert alert-info">You are using an <strong>outdated</strong> browser. Please <a href="http://browsehappy.com/">upgrade your browser</a> to improve your experience.</div><![endif]-->

    <div class="navigation-wrapper">
  <div class="site-name">
    <a href="http://enzolutions.com">[enzo]lutions</a>
  </div><!-- /.site-name -->
  <div class="top-navigation">
          <ul class="inline">
                    <li>
            <a href="http://enzolutions.com/"  >
              Home</a>
          </li>
                    <li>
            <a href="http://enzolutions.com/company"  >
              Company</a>
          </li>
                    <li>
            <a href="http://enzolutions.com/projects"  >
              Projects</a>
          </li>
                    <li>
            <a href="http://enzolutions.com/talks"  >
              Talks</a>
          </li>
                </ul>
      </div><!-- /.top-navigation -->
</div><!-- /.navigation-wrapper -->

          <div class="image-wrap">
  <img src="http://enzolutions.com/assets/images/blog_header_baby_turtle.png" alt="feature image">
  <span class="image-credit">Photo Credit: <a target="_blank" href="https://twitter.com/yersika">Yersika Ferreira</a></span>
</div><!-- /.image-wrap -->
    
  <div id="main" role="main">
    <div class="article-author-side">
      <img src="http://enzolutions.com/assets/images/enzo.png" class="bio-photo" alt="enzo - Eduardo Garcia bio photo">

<h3>enzo - Eduardo Garcia</h3>
<p>Home of crazy things I did just for fun</p>

<p> <a href="http://en.wikipedia.org/wiki/Costa_Rica" target="_blank"><img class="alignleft" src="http://enzolutions.com/assets/img/flags/cr.png" /></a> Current location</p>


<a href="http://twitter.com/enzolutions" class="author-social" target="_blank"><i class="fa fa-fw fa-twitter-square"></i> Twitter</a>

<a href="http://facebook.com/enzolutions" class="author-social" target="_blank"><i class="fa fa-fw fa-facebook-square"></i> Facebook</a>

<a href="http://plus.google.com/105943717171843527124" class="author-social" target="_blank"><i class="fa fa-fw fa-google-plus-square"></i> Google+</a>


<a href="http://github.com/enzolutions" class="author-social" target="_blank"><i class="fa fa-fw fa-github"></i> Github</a>

<a href="http://linkedin.com/in/edugarcia" class="author-social" target="_blank"><i class="fa fa-fw fa-linkedin"></i> LinkedIn</a>

<a href="http://enzolutions.com/rss.xml" class="author-social" target="_blank"><i class="fa fa-fw fa-rss"></i> Feed</a>
    </div>

  .
<article class="post">
  <div class="headline-wrap">
          <h1><a href="http://enzolutions.com/articles/2015/06/02/how-to-add-customs-fields-to-solr-index-using-entity-api-amp-search-api/" rel="bookmark" title="How to add customs fields to SOLR index using Entity API &amp; Search API">How to add customs fields to SOLR index using Entity API &amp; Search API</a></h1>
      </div><!--/ .headline-wrap -->
  <div class="article-wrap">
    <div class="social-share">
  <ul class="inline-list">
    <li class="facebook">
      <a href="https://www.facebook.com/sharer/sharer.php?u=http://enzolutions.com/articles/2015/06/02/how-to-add-customs-fields-to-solr-index-using-entity-api-amp-search-api/" title="Share on Facebook"><span class="count"><i class="fa fa-facebook-square"></i> Share</span></a>
    </li>
    <li class="twitter">
      <a href="https://twitter.com/intent/tweet?text=http://enzolutions.com/articles/2015/06/02/how-to-add-customs-fields-to-solr-index-using-entity-api-amp-search-api/" title="Share on Twitter"><span class="count"><i class="fa fa-twitter-square"></i> Tweet</span></a>
    </li>
    <li class="googleplus">
      <a href="https://plus.google.com/share?url=http://enzolutions.com/articles/2015/06/02/how-to-add-customs-fields-to-solr-index-using-entity-api-amp-search-api/" title="Share on Google Plus"><span class="count"><i class="fa fa-google-plus-square"></i> +1</span></a>
    </li>
  </ul>
</div>

    <p>Nowadays the ability to search in website almost compulsory and most of the times is took for granted.</p>

<p>Using Drupal we have two main options <a href="http://lucene.apache.org/solr/">SOLR</a> and <a href="https://www.elastic.co/">Elastic Search</a>. 
Today I will explore how to work SOLR server.</p>

<p>In Drupal there are two popular modules to connect it with <strong>SOLR</strong> <a href="https://www.drupal.org/project/apachesolr">apachesolr</a> and 
 <a href="https://www.drupal.org/project/search_api">search_api</a> and I decided to use <strong>search_api</strong> to interact with SOLR in 
this article.</p>

<h1>The problem</h1>

<p>Lets imagine this problem: We have an Event content type with a Date field to determine the start date and end date (optional).</p>

<p>Using Search API that field could be indexed without mayor problems, but if we try to do a view to list all event in a date range
 is difficult because Views modules doesn't provide the Between operator for SOLR views, this operator is only available
 for views using <strong>Entity Fields</strong></p>

<h1>The Solution</h1>

<p>Because all events have minute granularity we can't use <strong>equal</strong> operator to determine if an event belongs to a specific day, to 
solve that problem we add extra information to SOLR creating two new fields to store the day event in timestamp in order to be 
able to use the equal operator.</p>

<p>To create these new fields in our node entities we will use <a href="http://drupal.org/project/entity">Entity API</a> and more specifically 
hook <a href="http://www.drupalcontrib.org/api/drupal/contributions!entity!entity.api.php/function/hook_entity_property_info_alter/7">hook_entity_property_info_alter</a>.</p>

<p>Let me show you an implementation example.</p>

<pre><code>/**
 * Implements hook_entity_property_info_alter().
 */
function MYMODULE_entity_property_info_alter(&amp;$info) {
  $info['node']['properties']['event_start_day'] = array(
    'type' =&gt; 'integer',
    'label' =&gt; t('Event Start Day'),
    'sanitized' =&gt; TRUE,
    'getter callback' =&gt; 'MYMODULE_search_api_property_event_start_day_getter_callback',
  );
  $info['node']['properties']['event_end_day'] = array(
    'type' =&gt; 'integer',
    'label' =&gt; t('Event End Day'),
    'sanitized' =&gt; TRUE,
    'getter callback' =&gt; 'MYMODULE_search_search_api_property_event_end_day_getter_callback',
  );
}
</code></pre>

<p>As you can see we are modifying entity definition to include two new properties <strong>event_start_day</strong> and <strong>event_end_day</strong>,
probably the most information is the <strong>getter callback</strong> which is a function used to calculate the proper values for each 
property.</p>

<p>The functions defined in getter callback is used by Search API in the process of indexing to store the value in SOLR index.</p>

<p>Let me show an example of implementation of those getter functions.</p>

<pre><code>/**
 * Getter callback for event start day.
 */
function MYMODULE_search_api_property_event_start_day_getter_callback($item) {
  return strtotime(substr($item-&gt;field_event_date[LANGUAGE_NONE][0]['value'], 0, 10)); 
}

/**
 * Getter callback for event end day.
 */
function MYMODULE_search_search_api_property_event_end_day_getter_callback($item) {
  // Set time at midnight of end day of event
  if($item-&gt;field_event_date[LANGUAGE_NONE][0]['value2'] != '') {
    return strtotime(substr($item-&gt;field_event_date[LANGUAGE_NONE][0]['value2'], 0, 10)) + 86399;
  }
  else {
    return strtotime(substr($item-&gt;field_event_date[LANGUAGE_NONE][0]['value'], 0, 10)) + 86399;
  }
}
</code></pre>

<p>Off course you can implement any logic required here, the variable $item is an object representing a Drupal node.</p>

<p>After clear your cache the new fields will be able to select to be indexed by SOLR, you can do this accessing the URL 
<strong>http://example.com/admin/config/search/search_api/index/YOUR_INDEX/fields</strong> as you can see in the following 
image.</p>

<p><img style="float:left; margin-right: 20px;" src="http://enzolutions.com/assets/img/entity_fields_solr_index_search_api.png"/></p>

<p>When the process of re-index run again the new fields will be stored in SOLR and will be able to be selected in a View.</p>

<p>I hope you found this post useful.</p>

    <hr />
    <footer role="contentinfo">
            <p class="byline">Published on <time datetime="2015-06-02T16:38:35+0000">2015-06-02T16:38:35+0000</time>.</p>
      
              <ul class="list-unstyled">
                            <li>
                    <i class="fa fa-tags"></i>
                    Drupal, Entity API, Search API, SOLR
                </li>
                                        <li>
                    <i class="fa fa-folder"></i>
                    articles
                </li>
                    </ul>
          </footer>
  </div><!-- /.article-wrap -->
    <section>
    <h3>Comments</h3>
    <div id="disqus_thread"></div>
    <noscript>
      Please enable JavaScript to view the
      <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a>
    </noscript>
    <a href="http://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>
  </section>

      <script type="text/javascript">
        var disqus_shortname = 'enzolutions';

        (function() {
            var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
            dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
            (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
        })();
    </script>
  </article>

</div><!-- /#main -->

<div class="footer-wrap">
  <footer>
    <span>&copy; 2015 enzo - Eduardo Garcia.
            Design by <a target="_blank" href="https://mademistakes.com/">Michael Rose</a>,
          </li> Powered by <a target="_blank"href="http://spress.yosymfony.com">Spress</a> using the <a target="_blank" href="https://github.com/enzolutions/spress-tinto-theme/">Tinto</a> theme.</span>
<br/>
  </footer>
</div><!-- /.footer-wrap -->

<script src="//ajax.googleapis.com/ajax/libs/jquery/1.9.1/jquery.min.js"></script>
<script>window.jQuery || document.write('<script src="http://enzolutions.com/assets/js/vendor/jquery-1.9.1.min.js"><\/script>')</script>
<script src="http://enzolutions.com/assets/js/scripts.min.js"></script>

<script src="//cdnjs.cloudflare.com/ajax/libs/highlight.js/8.4/highlight.min.js"></script>
<script>hljs.initHighlightingOnLoad();</script>


      <!-- Google Analytics Tracker -->
      <script>
        (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
        (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
        m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
        })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

        ga('create', 'UA-17944133-1', 'enzolutions.com');
        ga('send', 'pageview');
      </script>
      <!-- End of Google Analytics Tracker -->
 </body> 
</html>
