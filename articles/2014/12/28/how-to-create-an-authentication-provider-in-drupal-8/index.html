<!DOCTYPE HTML>
<!--[if lt IE 7]><html class="no-js lt-ie9 lt-ie8 lt-ie7" lang="en"> <![endif]-->
<!--[if (IE 7)&!(IEMobile)]><html class="no-js lt-ie9 lt-ie8" lang="en"><![endif]-->
<!--[if (IE 8)&!(IEMobile)]><html class="no-js lt-ie9" lang="en"><![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en"><!--<![endif]-->
  <head>
    <title>How to create an Authentication Provider in Drupal 8</title>
<meta http-equiv="content-type" content="text/html; charset=utf-8" />
<meta name="generator" content="Spress" />
<meta name="description" content="Explanation to create a custom Autentication Provider in Drupal 8" />
<meta name="keywords" content="" />


<!-- Twitter Cards -->
<meta name="twitter:title" content="Welcome to [enzo]lutions">
<meta name="twitter:description" content="{ page.description | default(site.description) }}">
<meta name="twitter:site" content="@enzolutions">
<meta name="twitter:creator" content="@">

<meta name="twitter:card" content="summary_large_image">
<meta name="twitter:image" content="http://enzolutions.com/">

<!-- Open Graph -->
<meta property="og:locale" content="en_US">
<meta property="og:type" content="article">
<meta property="og:title" content="Welcome to [enzo]lutions">
<meta property="og:description" content="Explanation to create a custom Autentication Provider in Drupal 8">
<meta property="og:url" content="http://enzolutions.com">
<meta property="og:site_name" content="Welcome to [enzo]lutions">

<link rel="canonical" href="http://enzolutions.com">
<link href="http://enzolutions.com/rss.xml" type="application/atom+xml" rel="alternate" title="Welcome to [enzo]lutions">
<link rel="author" href="enzolutions">

<!-- http://t.co/dKP3o1e -->
<meta name="HandheldFriendly" content="True">
<meta name="MobileOptimized" content="320">
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<!-- For all browsers -->
<link rel="stylesheet" href="http://enzolutions.com/assets/css/main.css">

<meta http-equiv="cleartype" content="on">

<!-- HTML5 Shiv and Media Query Support -->
<!--[if lt IE 9]>
  <script src="http://enzolutions.com/assets/js/vendor/html5shiv.min.js"></script>
  <script src="http://enzolutions.com/assets/js/vendor/respond.min.js"></script>
<![endif]-->

<!-- Modernizr -->
<script src="http://enzolutions.com/assets/js/vendor/modernizr-2.7.1.custom.min.js"></script>

<link href='//fonts.googleapis.com/css?family=PT+Sans+Narrow:400,700%7CPT+Serif:400,700,400italic' rel='stylesheet' type='text/css'>

<!-- Icons -->
<!-- 16x16 -->
<link rel="shortcut icon" href="http://enzolutions.com/favicon.ico">
<!-- 32x32 -->
<link rel="shortcut icon" href="http://enzolutions.com/favicon.png">
<!-- 57x57 (precomposed) for iPhone 3GS, pre-2011 iPod Touch and older Android devices -->
<link rel="apple-touch-icon-precomposed" href="http://enzolutions.com/assets/images/apple-touch-icon-precomposed.png">
<!-- 72x72 (precomposed) for 1st generation iPad, iPad 2 and iPad mini -->
<link rel="apple-touch-icon-precomposed" sizes="72x72" href="http://enzolutions.com/assets/images/apple-touch-icon-72x72-precomposed.png">
<!-- 114x114 (precomposed) for iPhone 4, 4S, 5 and post-2011 iPod Touch -->
<link rel="apple-touch-icon-precomposed" sizes="114x114" href="http://enzolutions.com/assets/images/apple-touch-icon-114x114-precomposed.png">
<!-- 144x144 (precomposed) for iPad 3rd and 4th generation -->
<link rel="apple-touch-icon-precomposed" sizes="144x144" href="http://enzolutions.com/assets/images/apple-touch-icon-144x144-precomposed.png">

<link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/highlight.js/8.4/styles/default.min.css">
<link rel="stylesheet" href="http://enzolutions.com/assets/css/highlight-theme.css">
  </head>

  <body class="home">
    <!--[if lt IE 9]><div class="browser-upgrade alert alert-info">You are using an <strong>outdated</strong> browser. Please <a href="http://browsehappy.com/">upgrade your browser</a> to improve your experience.</div><![endif]-->

    <div class="navigation-wrapper">
  <div class="site-name">
    <a href="http://enzolutions.com">[enzo]lutions</a>
  </div><!-- /.site-name -->
  <div class="top-navigation">
          <ul class="inline">
                    <li>
            <a href="http://enzolutions.com/"  >
              Home</a>
          </li>
                    <li>
            <a href="http://enzolutions.com/company"  >
              Company</a>
          </li>
                    <li>
            <a href="http://enzolutions.com/projects"  >
              Projects</a>
          </li>
                    <li>
            <a href="http://enzolutions.com/talks"  >
              Talks</a>
          </li>
                </ul>
      </div><!-- /.top-navigation -->
</div><!-- /.navigation-wrapper -->

          <div class="image-wrap">
  <img src="http://enzolutions.com/assets/images/blog_header_baby_turtle.png" alt="feature image">
  <span class="image-credit">Photo Credit: <a target="_blank" href="https://twitter.com/yersika">Yersika Ferreira</a></span>
</div><!-- /.image-wrap -->
    
  <div id="main" role="main">
    <div class="article-author-side">
      <img src="http://enzolutions.com/assets/images/enzo.png" class="bio-photo" alt="enzo - Eduardo Garcia bio photo">

<h3>enzo - Eduardo Garcia</h3>
<p>Home of crazy things I did just for fun</p>

<p> <a href="http://en.wikipedia.org/wiki/Costa_Rica" target="_blank"><img class="alignleft" src="http://enzolutions.com/assets/img/flags/cr.png" /></a> Current location</p>


<a href="http://twitter.com/enzolutions" class="author-social" target="_blank"><i class="fa fa-fw fa-twitter-square"></i> Twitter</a>

<a href="http://facebook.com/enzolutions" class="author-social" target="_blank"><i class="fa fa-fw fa-facebook-square"></i> Facebook</a>

<a href="http://plus.google.com/105943717171843527124" class="author-social" target="_blank"><i class="fa fa-fw fa-google-plus-square"></i> Google+</a>


<a href="http://github.com/enzolutions" class="author-social" target="_blank"><i class="fa fa-fw fa-github"></i> Github</a>

<a href="http://linkedin.com/in/edugarcia" class="author-social" target="_blank"><i class="fa fa-fw fa-linkedin"></i> LinkedIn</a>

<a href="http://enzolutions.com/rss.xml" class="author-social" target="_blank"><i class="fa fa-fw fa-rss"></i> Feed</a>
    </div>

  .
<article class="post">
  <div class="headline-wrap">
          <h1><a href="http://enzolutions.com/articles/2014/12/28/how-to-create-an-authentication-provider-in-drupal-8/" rel="bookmark" title="How to create an Authentication Provider in Drupal 8">How to create an Authentication Provider in Drupal 8</a></h1>
      </div><!--/ .headline-wrap -->
  <div class="article-wrap">
    <div class="social-share">
  <ul class="inline-list">
    <li class="facebook">
      <a href="https://www.facebook.com/sharer/sharer.php?u=http://enzolutions.com/articles/2014/12/28/how-to-create-an-authentication-provider-in-drupal-8/" title="Share on Facebook"><span class="count"><i class="fa fa-facebook-square"></i> Share</span></a>
    </li>
    <li class="twitter">
      <a href="https://twitter.com/intent/tweet?text=http://enzolutions.com/articles/2014/12/28/how-to-create-an-authentication-provider-in-drupal-8/" title="Share on Twitter"><span class="count"><i class="fa fa-twitter-square"></i> Tweet</span></a>
    </li>
    <li class="googleplus">
      <a href="https://plus.google.com/share?url=http://enzolutions.com/articles/2014/12/28/how-to-create-an-authentication-provider-in-drupal-8/" title="Share on Google Plus"><span class="count"><i class="fa fa-google-plus-square"></i> +1</span></a>
    </li>
  </ul>
</div>

    <p>Some weeks ago I show you <a href="http://enzolutions.com/articles/2014/12/16/how-to-create-a-rest-resource-in-drupal-8" target="_blank">How to create a Rest Resource in Drupal 8</a> and as I explain in that post we use the Authentication Provider <strong>Basic Auth</strong> as you can see in the following image.</p>

<p><img src="http://enzolutions.com/assets/img/restui_bundle_entities_settings.png"/></p>

<p>Right now is the unique Authentication Provider available to use in a <a href="https://developer.mozilla.org/en-US/docs/Web/HTTP/Access_control_CORS" target="_blank">CORS</a> scenery. If you want to read more about CORS you can read the blog entry <a href="http://enzolutions.com2014/05/31/what-is-cross-origin-resource-sharing-cors" target="_blank">What is Cross-Origin Resource Sharing (CORS)</a>.</p>

<p>But what about if <strong>Basic Auth</strong> doesn't fit with your needs, well I will show you how to create a custom Authentication Provider.</p>

<h1>The Requirement</h1>

<p>My imaginary request will be create an Authentication Provider without user validation, that means access as <strong>Anonymous</strong> user, but we require to validate the source of request to check against an <strong>IP White List</strong> enabled to access our REST resources.</p>

<h1>Create a Module</h1>

<p>I will skip the explanation about how to create the Module <strong>ip_consumer_auth</strong> in Drupal 8 because could be generated using the project <a href="http://drupalconsole.com/" target="_blank">Drupal Console</a> executing the following command.</p>

<pre><code>$ drupal generate:module
</code></pre>

<p>After create the module with the console, we will use the console again to create a Form Configuration to create our <strong>IP White List</strong> using the following command.</p>

<pre><code>$ drupal generate:form:config
</code></pre>

<p>Now we must add a Textarea field to the form to store allowed IP Address. The implementation of method buildForm will looks similar to following snippet.</p>

<pre><code>/**
 * {@inheritdoc}
 */
public function buildForm(array $form, FormStateInterface $form_state) {
  $config = $this-&gt;config('ip_consumer_auth.consumers_form_config');
  $form['allowed_ip_consumers'] = [
    '#type' =&gt; 'textarea',
    '#title' =&gt; $this-&gt;t('Allowed IP Consumers'),
    '#description' =&gt; $this-&gt;t('Place IP addresses on separate lines'),
    '#default_value' =&gt; $config-&gt;get('allowed_ip_consumers'),
  ];
  return parent::buildForm($form, $form_state);
}
</code></pre>

<p>The form class will be located at <strong>ip_consumer_auth/src/Form/ConsumersForm.php</strong></p>

<p>The layout to enter allowed IP consumer will looks similar to this image</p>

<p><img src="http://enzolutions.com/assets/img/allowed_ip_resources.png"/></p>

<p>The code to save that values are generated by <strong>Drupal Console</strong>, in the same way the Routing is created. Be sure you change the values to your convenience after generate the form.</p>

<h1>Create Authentication Provider</h1>

<p>Before to start with code for our Authetication Provider we need to inform to <strong>Drupal 8</strong> the existence of our custom Authentication Provider, to do that we add a new file in our module named <strong>ip_consumer_auth.service.yml</strong> because my module name is <strong>ip_consumer_auth</strong>.</p>

<p>Let me show you the content of that file</p>

<pre><code>services:
  authentication.ip_consumer_auth:
    class: Drupal\ip_consumer_auth\Authentication\Provider\IPConsumerAuth
    arguments: ['@config.factory', '@entity.manager']
    tags:
      - { name: authentication_provider, priority: 100 }
</code></pre>

<p>The discover for services will find this file and registering our Authentication Provider Class <strong>Drupal\ip_consumer_auth\Authentication\Provider\IPConsumerAuth</strong> and prepare the elements to send to constructor.</p>

<p>With the sentence above we don't have to implement the method <strong>create</strong> in our class, because the Discover send the parameters using <a href="http://en.wikipedia.org/wiki/Dependency_injection" target="_blank">Dependency Injection</a>.</p>

<p>At the end we define the priority, this value will define the execution order if multiple Authentication Provider were enabled.</p>

<h2>Implement Class Authentication Provider IPConsumerAuth</h2>

<p>Our class <strong>IPConsumerAuth</strong> must implement the interface <a href="https://api.drupal.org/api/drupal/core!lib!Drupal!Core!Authentication!AuthenticationProviderInterface.php/interface/AuthenticationProviderInterface/8" target="_blank">AuthenticationProviderInterface</a> as you can see in the following snippet.</p>

<pre><code>/**
 * IP Consumer authentication provider.
 */
class IPConsumerAuth implements AuthenticationProviderInterface {
}
</code></pre>

<h2>Libraries</h2>

<p>The Authentication Provider require some libraries and we must to inform to AutoLoader where are these libraries, let me show the complete list.</p>

<pre><code>namespace Drupal\ip_consumer_auth\Authentication\Provider;

use \Drupal\Component\Utility\String;
use Drupal\Core\Authentication\AuthenticationProviderInterface;
use Drupal\Core\Config\ConfigFactoryInterface;
use Drupal\Core\Entity\EntityManagerInterface;
use Drupal\Core\Flood\FloodInterface;
use Drupal\user\UserAuthInterface;
use Symfony\Component\HttpFoundation\Request;
use Symfony\Component\HttpKernel\Event\GetResponseForExceptionEvent;
use Symfony\Component\HttpKernel\Exception\UnauthorizedHttpException;
use Symfony\Component\HttpKernel\Exception\AccessDeniedHttpException;
</code></pre>

<h2>Implement method applies</h2>

<p>Even if the Authentication Provider is enabled for some REST resource is required a validation to confirm the Authentication Provider apply for current Request.</p>

<p>In our case if our Authentication Provider was enabled we will add any extra validation as you can see in the following implementation.</p>

<pre><code>/**
 * {@inheritdoc}
 */
public function applies(Request $request) {
  // If Authentication Provider is enabled always apply
  return TRUE;
}
</code></pre>

<h2>Implement method authenticate</h2>

<p>Now we have to implement the logic to execute to validate the Request, check the following snippet.</p>

<pre><code>/**
 * {@inheritdoc}
 */
public function authenticate(Request $request) {
  $allowed_ip_consumers = $this-&gt;configFactory-&gt;get('ip_consumer_auth.consumers_form_config')-&gt;get('allowed_ip_consumers');
  $ips = array_map('trim', explode( "\n", $allowed_ip_consumers));
  $consumer_ip = $request-&gt;getClientIp(TRUE);
  if (in_array($consumer_ip, $ips)) {
    // Return Anonymous user
    return $this-&gt;entityManager-&gt;getStorage('user')-&gt;load(0);
  }
  else{
    throw new AccessDeniedHttpException();
    return null;
  }
}
</code></pre>

<p>In the implementation above I use the <strong>configFactory</strong> to get the information stored about allowed IP Consumer using the Settings form created before.</p>

<p>The authenticate method receive an <a href="http://api.symfony.com/2.0/Symfony/Component/HttpFoundation/Request.html" target="_blank">Request</a> object defined in <a href="http://symfony.com/doc/current/components/http_foundation/introduction.html"></a>The HttpFoundation Component</a> of <a href="http://symfony.com/" target="_blank">Symfony</a>.</p>

<p>Using the Request method <a href="http://api.symfony.com/2.0/Symfony/Component/HttpFoundation/Request.html#method_getClientIp" target="_blank">getClientIp</a> we get the IP of Consumer.</p>

<p>I used the PHP functions <a href="http://php.net/manual/es/function.explode.php" target="_blank">explode</a>, <a href="http://php.net/manual/es/function.array-map.php" target="_blank">array_map</a> and <a href="http://php.net/manual/en/function.in-array.php" target="_blank">in_array</a> to determine if IP consumer belong to Allowed IP consumer. I know maybe with a regex will be more efficient but I really sucks in Regex.</p>

<p>If validation pass I return an Account object for Anonymous user, if fail an Access Denied Exception is throw.</p>

<h2>Implement method handleException</h2>

<p>If the IP wasn't in the allowed list of IP Consumer an exception is throw, using the method <strong>handleException</strong> we have the option to intercept and process to produce any output desired.</p>

<p>Let me share with you my implementation</p>

<pre><code>  /**
   * {@inheritdoc}
   */
  public function cleanup(Request $request) {}

  /**
   * {@inheritdoc}
   */
  public function handleException(GetResponseForExceptionEvent $event) {
    $exception = $event-&gt;getException();
    if ($exception instanceof AccessDeniedHttpException) {
      $event-&gt;setException(new UnauthorizedHttpException('Invalid consumer origin.', $exception));
      return TRUE;
    }
    return FALSE;
  }
</code></pre>

<p>As you can see is not to complex, but is just an idea above what you can do with this method.</p>

<h1>Usage</h1>

<p>After create our module with our custom Authentication Provider and enable it, we are ready to start to use.</p>

<p>Lets imagine you install the module <a href="https://github.com/enzolutions/entity_rest_extra" target="_blank">Entity Rest Extra</a> and we will use our Authentication Provider.</p>

<p>Using the <a href="https://www.drupal.org/project/restui/git-instructions" target="_blank">Rest UI</a>(I recommend to use the git version until Drupal 8 get a first release) module we enable the REST Resource and enable our Custom Authentication Provider, as you can see in the following image.</p>

<p><img src="http://enzolutions.com/assets/img/custom_authentication_provider.png"/></p>

<h2>Access Denied</h2>

<p>Now if you try to access via CORS the REST end point <strong>http://example.com/bundles/node</strong> you will get an error <strong>403 Forbidden</strong> because the allowed IP consumers weren't defined yet.</p>

<h2>Unauthorized</h2>

<p>After enable your IP consumer and try again <strong>http://example.com/bundles/node</strong> you will get an error <strong>401 Unauthorized</strong></p>

<p>If that error doesn't have any logic for you let me explain, remember in our Authentication Provider we don't have information about any user, so if the request pass the validation of IP Consumer we return an Anonymous user.</p>

<p>When we enable any REST Resource in Drupal 8 a new set of  permissions is created, in our case we have to assign the permission <strong>Access GET on Bundles by entities resource</strong> to Anonymous user as you can see in the following image.</p>

<p><img src="http://enzolutions.com/assets/img/rest_anonymous_permission.png"/></p>

<h2>Access Denied AGAIN</h2>

<p>Well maybe at this point you get MAD with me, because now you get again an error
 <strong>403 Forbidden</strong>, but at this time the fault is not caused by Authentication Provider or by Rest permission itself.</p>

<p>The error now is related with REST Resource itself is you check the code of module <strong>Entity Rest Extra</strong> you will found the permission <strong>Administer content types</strong> is required to access this Resource.</p>

<h2>Bonus</h2>

<p>Well you can complain about nobody inform to you that module has own permissions validation or the REST permissions, well that could be true.</p>

<p>If you want to get more information about a specific Drupal 8 router you can use the <strong>Drupal Console</strong>.</p>

<p>First thing you have to do is determine the Router id, we can you the canonical URL of REST resource as you can see in the following command.</p>

<pre>
 $ console router:debug | grep bundles/{entity}
 rest.entity_bundles.GET.json                             /bundles/{entity}
 </pre>

<p>Now we can get more information about router using the following command.</p>

<pre>
 $ console router:debug rest.entity_bundles.GET.json
 Route name                   Options
 rest.entity_bundles.GET.json
  + Pattern                   /bundles/{entity}
  + Defaults
   - _controller              Drupal\rest\RequestHandler::handle
   - _plugin                  entity_bundles
  + Options
   - compiler_class           \Drupal\Core\Routing\RouteCompiler
   - _access_mode             ANY
   - 0                        ip_consumer_auth
   - 0                        access_check.permission
  </pre>

<p>As you can see the last thing executed is access_check.permission generating the error 401. Maybe in the future the internal permissions in resourced will be included.</p>

<p>If you want see a complete implementation of Authentication provider you clone the project <a href="https://github.com/enzolutions/ip_consumer_auth" target="_blank">IP Consumer Auth</a></p>

<p>I hope you found this blog entry useful.</p>

    <hr />
    <footer role="contentinfo">
            <p class="byline">Published on <time datetime="2014-12-28T14:20:58+0000">2014-12-28T14:20:58+0000</time>.</p>
      
              <ul class="list-unstyled">
                            <li>
                    <i class="fa fa-tags"></i>
                    Drupal, Drupal Modules, Rest
                </li>
                                        <li>
                    <i class="fa fa-folder"></i>
                    articles
                </li>
                    </ul>
          </footer>
  </div><!-- /.article-wrap -->
    <section>
    <h3>Comments</h3>
    <div id="disqus_thread"></div>
    <noscript>
      Please enable JavaScript to view the
      <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a>
    </noscript>
    <a href="http://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>
  </section>

      <script type="text/javascript">
        var disqus_shortname = 'enzolutions';

        (function() {
            var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
            dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
            (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
        })();
    </script>
  </article>

</div><!-- /#main -->

<div class="footer-wrap">
  <footer>
    <span>&copy; 2015 enzo - Eduardo Garcia.
            Design by <a target="_blank" href="https://mademistakes.com/">Michael Rose</a>,
          </li> Powered by <a target="_blank"href="http://spress.yosymfony.com">Spress</a> using the <a target="_blank" href="https://github.com/enzolutions/spress-tinto-theme/">Tinto</a> theme.</span>
<br/>
  </footer>
</div><!-- /.footer-wrap -->

<script src="//ajax.googleapis.com/ajax/libs/jquery/1.9.1/jquery.min.js"></script>
<script>window.jQuery || document.write('<script src="http://enzolutions.com/assets/js/vendor/jquery-1.9.1.min.js"><\/script>')</script>
<script src="http://enzolutions.com/assets/js/scripts.min.js"></script>

<script src="//cdnjs.cloudflare.com/ajax/libs/highlight.js/8.4/highlight.min.js"></script>
<script>hljs.initHighlightingOnLoad();</script>


      <!-- Google Analytics Tracker -->
      <script>
        (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
        (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
        m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
        })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

        ga('create', 'UA-17944133-1', 'enzolutions.com');
        ga('send', 'pageview');
      </script>
      <!-- End of Google Analytics Tracker -->
 </body> 
</html>
