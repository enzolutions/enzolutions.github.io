<!DOCTYPE HTML>
<!--[if lt IE 7]><html class="no-js lt-ie9 lt-ie8 lt-ie7" lang="en"> <![endif]-->
<!--[if (IE 7)&!(IEMobile)]><html class="no-js lt-ie9 lt-ie8" lang="en"><![endif]-->
<!--[if (IE 8)&!(IEMobile)]><html class="no-js lt-ie9" lang="en"><![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en"><!--<![endif]-->
  <head>
    <title>How to create a Field Formatter in Drupal 8</title>
<meta http-equiv="content-type" content="text/html; charset=utf-8" />
<meta name="generator" content="Spress" />
<meta name="description" content="Explanation to create a custom Field Formatter in Drupal 8" />
<meta name="keywords" content="" />


<!-- Twitter Cards -->
<meta name="twitter:title" content="Welcome to [enzo]lutions">
<meta name="twitter:description" content="Explanation to create a custom Field Formatter in Drupal 8">
<meta name="twitter:site" content="@enzolutions">
<meta name="twitter:creator" content="@enzolutions">

<meta name="twitter:card" content="summary_large_image">
<meta name="twitter:image" content="http://enzolutions.com/assets/images/blog_header_baby_turtle.png">

<!-- Open Graph -->
<meta property="og:locale" content="en_US">
<meta property="og:type" content="article">
<meta property="og:title" content="Welcome to [enzo]lutions">
<meta property="og:description" content="Explanation to create a custom Field Formatter in Drupal 8">
<meta property="og:url" content="http://enzolutions.com">
<meta property="og:site_name" content="Welcome to [enzo]lutions">

<link rel="canonical" href="http://enzolutions.com">
<link href="http://enzolutions.com/rss.xml" type="application/atom+xml" rel="alternate" title="Welcome to [enzo]lutions">
<link rel="author" href="enzolutions">

<!-- http://t.co/dKP3o1e -->
<meta name="HandheldFriendly" content="True">
<meta name="MobileOptimized" content="320">
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<!-- For all browsers -->
<link rel="stylesheet" href="http://enzolutions.com/assets/css/main.css">

<meta http-equiv="cleartype" content="on">

<!-- HTML5 Shiv and Media Query Support -->
<!--[if lt IE 9]>
  <script src="http://enzolutions.com/assets/js/vendor/html5shiv.min.js"></script>
  <script src="http://enzolutions.com/assets/js/vendor/respond.min.js"></script>
<![endif]-->

<!-- Modernizr -->
<script src="http://enzolutions.com/assets/js/vendor/modernizr-2.7.1.custom.min.js"></script>

<link href='//fonts.googleapis.com/css?family=PT+Sans+Narrow:400,700%7CPT+Serif:400,700,400italic' rel='stylesheet' type='text/css'>

<!-- Icons -->
<!-- 16x16 -->
<link rel="shortcut icon" href="http://enzolutions.com/favicon.ico">
<!-- 32x32 -->
<link rel="shortcut icon" href="http://enzolutions.com/favicon.png">
<!-- 57x57 (precomposed) for iPhone 3GS, pre-2011 iPod Touch and older Android devices -->
<link rel="apple-touch-icon-precomposed" href="http://enzolutions.com/assets/images/apple-touch-icon-precomposed.png">
<!-- 72x72 (precomposed) for 1st generation iPad, iPad 2 and iPad mini -->
<link rel="apple-touch-icon-precomposed" sizes="72x72" href="http://enzolutions.com/assets/images/apple-touch-icon-72x72-precomposed.png">
<!-- 114x114 (precomposed) for iPhone 4, 4S, 5 and post-2011 iPod Touch -->
<link rel="apple-touch-icon-precomposed" sizes="114x114" href="http://enzolutions.com/assets/images/apple-touch-icon-114x114-precomposed.png">
<!-- 144x144 (precomposed) for iPad 3rd and 4th generation -->
<link rel="apple-touch-icon-precomposed" sizes="144x144" href="http://enzolutions.com/assets/images/apple-touch-icon-144x144-precomposed.png">

<link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/highlight.js/8.4/styles/default.min.css">
<link rel="stylesheet" href="http://enzolutions.com/assets/css/highlight-theme.css">
  </head>

  <body class="home">
    <!--[if lt IE 9]><div class="browser-upgrade alert alert-info">You are using an <strong>outdated</strong> browser. Please <a href="http://browsehappy.com/">upgrade your browser</a> to improve your experience.</div><![endif]-->

    <div class="navigation-wrapper">
  <div class="site-name">
    <a href="http://enzolutions.com">[enzo]lutions</a>
  </div><!-- /.site-name -->
  <div class="top-navigation">
          <ul class="inline">
                    <li>
            <a href="http://enzolutions.com/"  >
              Home</a>
          </li>
                    <li>
            <a href="http://enzolutions.com/company"  >
              Company</a>
          </li>
                    <li>
            <a href="http://enzolutions.com/projects"  >
              Projects</a>
          </li>
                    <li>
            <a href="http://enzolutions.com/talks"  >
              Talks</a>
          </li>
                </ul>
      </div><!-- /.top-navigation -->
</div><!-- /.navigation-wrapper -->

          <div class="image-wrap">
  <img src="http://enzolutions.com/assets/images/blog_header_baby_turtle.png" alt="feature image">
  <span class="image-credit">Photo Credit: <a target="_blank" href="https://twitter.com/yersika">Yersika Ferreira</a></span>
</div><!-- /.image-wrap -->
    
  <div id="main" role="main">
    <div class="article-author-side">
      <img src="http://enzolutions.com/assets/images/enzo.png" class="bio-photo" alt="enzo - Eduardo Garcia bio photo">

<h3>enzo - Eduardo Garcia</h3>
<p>Knowmad by definition</p>

<p> <a href="https://en.wikipedia.org/wiki/Vietnam" target="_blank"><img class="alignleft" src="http://enzolutions.com/assets/img/flags/vn.png" /></a> Location: Vietnam</p>


<a href="http://twitter.com/enzolutions" class="author-social" target="_blank"><i class="fa fa-fw fa-twitter-square"></i> Twitter</a>

<a href="http://facebook.com/enzolutions" class="author-social" target="_blank"><i class="fa fa-fw fa-facebook-square"></i> Facebook</a>

<a href="http://wpa.qq.com/msgrd?v=3&uin=2869823852&site=qq&menu=yes" class="author-social" target="_blank"><i class="fa fa-fw fa-qq"></i> &nbsp;QQ交谈</a>

<a href="http://plus.google.com/105943717171843527124" class="author-social" target="_blank"><i class="fa fa-fw fa-google-plus-square"></i> Google+</a>


<a href="http://github.com/enzolutions" class="author-social" target="_blank"><i class="fa fa-fw fa-github"></i> Github</a>

<a href="http://linkedin.com/in/edugarcia" class="author-social" target="_blank"><i class="fa fa-fw fa-linkedin"></i> LinkedIn</a>

<a href="http://enzolutions.com/rss.xml" class="author-social" target="_blank"><i class="fa fa-fw fa-rss"></i> Feed</a>
    </div>

  <article class="post">
  <div class="headline-wrap">
          <h1><a href="http://enzolutions.com/articles/2014/12/09/how-to-create-a-field-formatter-in-drupal-8" rel="bookmark" title="How to create a Field Formatter in Drupal 8">How to create a Field Formatter in Drupal 8</a></h1>
      </div><!--/ .headline-wrap -->
  <div class="article-wrap">
    <div class="social-share">
  <ul class="inline-list">
    <li class="facebook">
      <a href="https://www.facebook.com/sharer/sharer.php?u=http://enzolutions.com/articles/2014/12/09/how-to-create-a-field-formatter-in-drupal-8" title="Share on Facebook"><span class="count"><i class="fa fa-facebook-square"></i> Share</span></a>
    </li>
    <li class="twitter">
      <a href="https://twitter.com/intent/tweet?text=http://enzolutions.com/articles/2014/12/09/how-to-create-a-field-formatter-in-drupal-8" title="Share on Twitter"><span class="count"><i class="fa fa-twitter-square"></i> Tweet</span></a>
    </li>
    <li class="googleplus">
      <a href="https://plus.google.com/share?url=http://enzolutions.com/articles/2014/12/09/how-to-create-a-field-formatter-in-drupal-8" title="Share on Google Plus"><span class="count"><i class="fa fa-google-plus-square"></i> +1</span></a>
    </li>
  </ul>
</div>

    <p>One of the biggest changes in <a href="https://www.drupal.org/drupal-8.0" target="_blank">Drupal 8</a> is his integration with <a href="http://en.wikipedia.org/wiki/Representational_state_transfer" target="_blank">RESTful</a>.</p>

<p>Because now Views lives in Core you can create a view with JSON response in few minutes, you just need enable modules <strong>Views</strong>, <strong>Views UI</strong> and <strong>RESTful Web Services</strong></p>

<p>The problem I found with image is the formatter for image is not compatible with RESTful responses due the output of Image formatter is HTML.</p>

<h1>Create a View</h1>

<p>Let me explain the situation if you create a view with a <strong>Rest Export</strong> display you can select what fields of your entity you want to render.</p>

<p>Now if you choose an image field the default format is Image as you can see in the following snapshot.</p>

<p><img src="http://enzolutions.com/assets/img/image_field_formatter.png"/></p>

<p>Even if you don't set the option to link to original image you will get the image in HTML format as you see in the following sample of JSON response.</p>

<pre><code>[
  {
    title: "Image sample # 3",
    field_image: " &lt;img src="http://example.com/sites/default/files/styles/thumbnail/public/field/image/globe.jpg?itok=wmu3VCr6" width="100" height="75" alt="" typeof="foaf:Image" class="image-style-thumbnail" /&gt; "
  },
  {
    title: "Image sample # 2",
    field_image: " &lt;img src="http://example.com/sites/default/files/styles/thumbnail/public/field/image/sample_08.jpg?itok=X9N005N1" width="100" height="75" alt="" typeof="foaf:Image" class="image-style-thumbnail" /&gt; "
  },
  {
    title: "Image sample # 1",
    field_image: " &lt;img src="http://d$/sites/default/files/styles/thumbnail/public/field/image/sample_01.jpg?itok=UD1-QXTj" width="100" height="75" alt="" typeof="foaf:Image" class="image-style-thumbnail" /&gt; "
  }
]
</code></pre>

<p>The previous output was generated by a view selecting articles with images, if you want import this view in your system just download the file <a href="http://enzolutions.com/assets/attaches/view_image_list.yml" target="_blank">views_list.yml</a> and import using the Configuration Management of Drupal accessing the URL <strong>http://example.com/admin/config/development/configuration/single/import</strong> in your Drupal install as you can see in the following image.</p>

<p><img src="http://enzolutions.com/assets/img/configuration_management_view_import.png"/></p>

<p>If you want read more about Configuration Management in Drupal 8 you can read the post entry <a href="{site.url}}/articles/2014/08/27/understanding-configuration-management-in-drupal-8/">Understanding Configuration Management in Drupal 8</a></p>

<p>To resolve this problem I will show you how to create your own Field Formatter to meet your needs.</p>

<h1>Create a Module</h1>

<p>I will skip the explanation about how to create a Module in Drupal 8 because could be generated using the project <a href="http://drupalconsole.com/" target="_blank">Drupal Console</a> executing the following command.</p>

<pre><code>$ php console.phar generate:module
</code></pre>

<h1>Create a new Field Formatter</h1>

<p>If you want to create a new custom Field Formatter is require to add a new class file located inside your module in the following path</p>

<pre><code>YOUR_MODULE/src/Plugin/Field/FieldFormatter/
</code></pre>

<p>Inside this folder you must create a class file per each Field Formatter do you want to create.</p>

<p>I will create a new file named <strong>ImageRawFormatter.php</strong>, I will explain each part of this file</p>

<h2>Field Formatter Metadata</h2>

<p>Before to start to code we must to define some stuff required for a proper function.</p>

<h3>Namespace</h3>

<p>We have to define what will be Namespace for your Field Formatter</p>

<pre><code>namespace Drupal\image_raw_formatter\Plugin\Field\FieldFormatter;
</code></pre>

<p>Drupal 8 implement <a href="http://www.php-fig.org/psr/psr-4/" target="_blank">PSR-4</a> from  <a href="http://www.php-fig.org/" target="_blank">PHP Framework Interop Group</a></p>

<p>This specification follow the following pattern</p>

<pre><code>\&lt;NamespaceName&gt;(\&lt;SubNamespaceNames&gt;)*\&lt;ClassName&gt;
</code></pre>

<p>In our case the division will be</p>

<ul>
<li><strong>NamespaceName</strong>: Drupal</li>
<li><strong>SubNamespaceNames</strong>: image_raw_formatter\Plugin\Field\FieldFormatter</li>
<li><strong>ClassName</strong>: ImageRawFormatter</li>
</ul>

<h2>Libraries required</h2>

<p>In this specific case we have to define where are classes we require to create our Field Formatter.</p>

<p>Drupal 8 use Autoloader class but we need to inform where they are using the intruction <strong>use</strong>.</p>

<pre><code>use Drupal\image\Plugin\Field\FieldFormatter\ImageFormatterBase;
use Drupal\image\Entity\ImageStyle;
use Drupal\Core\Form\FormStateInterface;
use Drupal\Core\Field\FieldItemListInterface;
use \InvalidArgumentException;
</code></pre>

<h3>Annotations</h3>

<p>Drupal 8 have several discovers to detect specific implementation, for instance we have a Discover to detect all Field Formatter declared in our application and the way to declare a new Field Formatter is using <a href="https://wiki.php.net/rfc/annotations" target="_blank">Annotations</a>.</p>

<p>Below you can find an annotation example for Field Formatter</p>

<pre><code>/**
 * Plugin implementation of the 'image_raw_formatter' formatter.
 *
 * @FieldFormatter(
 *   id = "image_raw_formatter",
 *   label = @Translation("Image Raw"),
 *   field_types = {
 *     "image"
 *   }
 * )
 */
</code></pre>

<p>As you can see we must define an unique <strong>id</strong> with a <strong>label</strong> with translation and we must define for which field types this Field Formatter will be available.</p>

<h2>Implement Class</h2>

<p>Now we have to create a class extending from <a href="https://api.drupal.org/api/drupal/core%21modules%21image%21src%21Plugin%21Field%21FieldFormatter%21ImageFormatterBase.php/class/ImageFormatterBase/8">ImageFormatterBase</a> as you can see in the following snippet</p>

<pre><code>class ImageRawFormatter extends ImageFormatterBase
{
}
</code></pre>

<h3>Settings Form</h3>

<p>Now we have to add a method <strong>settingsForm</strong> to define the Setting options for our Formatter. check the following implementation.</p>

<pre><code>/**
   * {@inheritdoc}
   */
  public function settingsForm(array $form, FormStateInterface $form_state) {
    $image_styles = image_style_options(FALSE);
    $element['image_style'] = array(
      '#title' =&gt; t('Image style'),
      '#type' =&gt; 'select',
      '#default_value' =&gt; $this-&gt;getSetting('image_style'),
      '#empty_option' =&gt; t('None (original image)'),
      '#options' =&gt; $image_styles,
    );
    return $element;
  }
</code></pre>

<p>The implementation above allow user select a specific image style to be returned or just return the original image.</p>

<h3>Summary Report</h3>

<p>Is important to inform to end users current setting of formatter, to enable that we have to implement the method <strong>settingsSummary</strong></p>

<pre><code>/**
   * {@inheritdoc}
   */
  public function settingsSummary() {
    $summary = array();
    $image_styles = image_style_options(FALSE);
    // Unset possible 'No defined styles' option.
    unset($image_styles['']);
    // Styles could be lost because of enabled/disabled modules that defines
    // their styles in code.
    $image_style_setting = $this-&gt;getSetting('image_style');
    if (isset($image_styles[$image_style_setting])) {
      $summary[] = t('Image style: @style', array('@style' =&gt; $image_styles[$image_style_setting]));
    }
    else {
      $summary[] = t('Original image');
    }
    return $summary;
  }
</code></pre>

<p>As you can see the method above just read the current settings and render an output.</p>

<h3>Render Field Formatter</h3>

<p>At the end we need to define the how we want to render the field based in current Field Formatter settings, we have to implement the method <strong>viewElements</strong> as you can see in the following snippet.</p>

<pre><code>/**
   * {@inheritdoc}
   */
  public function viewElements(FieldItemListInterface $items) {
    $elements = array();
    $image_style_setting = $this-&gt;getSetting('image_style');

    // Determine if Image style is required.
    $image_style = NULL;
    if (!empty($image_style_setting)) {
      $image_style = entity_load('image_style', $image_style_setting);
    }
    foreach ($items as $delta =&gt; $item) {
      if ($item-&gt;entity) {
        $image_uri = $item-&gt;entity-&gt;getFileUri();
        // Get image style URL
        if ($image_style) {
          $image_uri = ImageStyle::load($image_style-&gt;getName())-&gt;buildUrl($image_uri);
        } else {
          // Get absolute path for original image
          $image_uri = $item-&gt;entity-&gt;url();
        }
        $elements[$delta] = array(
          '#markup' =&gt; $image_uri,
        );
      }
    }
    return $elements;
  }
</code></pre>

<p>If you read the logic only determine if the configuration require use any image style or if is only required the original image, in both sceneries the proper path url is return.</p>

<p>We don't need any transformation to JSON because that is handled by view Display selected.</p>

<h1>Module usage</h1>

<p>After enable our custom module we just need edit our view and edit the field to use new Raw Formatter as you can see in the following image.</p>

<p><img src="http://enzolutions.com/assets/img/image_field_raw_formatter.png"/></p>

<p>After save the view and run again the output will be totally different and perfect to use in RESTful services to avoid HTML parsing to extract the image path. check the output example below.</p>

<pre><code>[
  {
    title: "Image sample # 3",
    field_image: "http://drupal8b3.dev/sites/default/files/styles/thumbnail/public/field/image/globe.jpg?itok=wmu3VCr6"
  },
  {
    title: "Image sample # 2",
    field_image: "http://drupal8b3.dev/sites/default/files/styles/thumbnail/public/field/image/sample_08.jpg?itok=X9N005N1"
  },
  {
    title: "Image sample # 1",
    field_image: "http://drupal8b3.dev/sites/default/files/styles/thumbnail/public/field/image/sample_01.jpg?itok=UD1-QXTj"
  }
]
</code></pre>

<p>You can download a full implementation of this custom Image Raw Field Formatter at <a href="https://github.com/enzolutions/image_raw_formatter" target="_blank">https://github.com/enzolutions/image_raw_formatter</a>.</p>

<p>I expect you found this blog entry useful.</p>

    <hr />
    <footer role="contentinfo">
              <ul class="list-unstyled">
                            <li>
                    <i class="fa fa-tags"></i>
                                        <a href="http://enzolutions.com/tags/drupal">drupal</a>,                                        <a href="http://enzolutions.com/tags/drupal-modules">drupal modules</a>                                    </li>
                                        <li>
                    <i class="fa fa-folder"></i>
                                        <a href="http://enzolutions.com/categories/articles">articles</a>                                    </li>
                    </ul>
          </footer>
  </div><!-- /.article-wrap -->
    <section>
    <h3>Comments</h3>
    <div id="disqus_thread"></div>
    <noscript>
      Please enable JavaScript to view the
      <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a>
    </noscript>
    <a href="http://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>
  </section>

      <script type="text/javascript">
        var disqus_shortname = 'enzolutions';

        (function() {
            var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
            dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
            (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
        })();
    </script>
  </article>

</div><!-- /#main -->

<div class="footer-wrap">
  <footer>
    <span>&copy; 2014 - 2016 enzo - Eduardo Garcia.</span><br/>
<span>Design by <a target="_blank" href="https://mademistakes.com/">Michael Rose</a></span><br/>
</span></li> Powered by <a target="_blank"href="http://spress.yosymfony.com">Spress </a> 2.0.1, using the <a target="_blank" href="https://github.com/enzolutions/spress-tinto-theme/">Tinto</a> theme.</span>
<br/>
  </footer>
</div><!-- /.footer-wrap -->

<script src="//ajax.googleapis.com/ajax/libs/jquery/1.9.1/jquery.min.js"></script>
<script>window.jQuery || document.write('<script src="http://enzolutions.com/assets/js/vendor/jquery-1.9.1.min.js"><\/script>')</script>
<script src="http://enzolutions.com/assets/js/scripts.min.js"></script>

<script src="//cdnjs.cloudflare.com/ajax/libs/highlight.js/8.4/highlight.min.js"></script>
<script>hljs.initHighlightingOnLoad();</script>


      <!-- Google Analytics Tracker -->
      <script>
        (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
        (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
        m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
        })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

        ga('create', 'UA-17944133-1', 'enzolutions.com');
        ga('send', 'pageview');
      </script>
      <!-- End of Google Analytics Tracker -->
 </body> 
</html>
